blueprint:
  name: "Boiler Weather Compensation with Solar Gain"
  description: >-
    Adjusts boiler flow temperature based on outdoor temperature and sun
    illuminance (lux). Uses the radiator nonlinearity exponent (0.78) from the
    Vaillant/Kühne heat curves, but without coupling to any single room
    temperature — ideal for multi-zone houses where each zone has its own
    thermostat or TRV.

    On sunny days, the flow temperature is reduced to prevent overheating from
    solar gain through windows.

    Reference:
    https://protonsforbreakfast.wordpress.com/2024/10/16/vaillant-heat-pump-controls-part-1-the-heat-curves/
  domain: automation
  source_url: https://github.com/dlbogdan/boiler-outdoor-dep/blob/main/boiler_weather_compensation.yaml

  input:
    # ── Entity selection (proper UI pickers) ──────────────────────────────
    outdoor_temp_sensor:
      name: "Outdoor Temperature Sensor"
      description: "Sensor that reports outdoor temperature in °C"
      selector:
        entity:
          domain: sensor
          device_class: temperature

    outdoor_lux_sensor:
      name: "Outdoor Illuminance Sensor"
      description: "Sensor that reports outdoor light level in lux"
      selector:
        entity:
          domain: sensor
          device_class: illuminance

    boiler_climate:
      name: "Boiler / Heating Climate Entity"
      description: "Climate entity used to set the boiler flow temperature"
      selector:
        entity:
          domain: climate

    # ── Heat curve anchor points ──────────────────────────────────────────
    design_outdoor_temp:
      name: "Design Outdoor Temperature"
      description: "Coldest outdoor temperature you expect (°C)"
      default: -20
      selector:
        number:
          min: -30
          max: 5
          step: 1
          unit_of_measurement: "°C"
          mode: slider

    design_flow_temp:
      name: "Design Flow Temperature"
      description: "Flow temperature needed on the coldest day (°C). Calibrated: 77 °C at -20 °C gives ~54 °C at 0 °C (with curve base 25 °C)."
      default: 77
      selector:
        number:
          min: 30
          max: 80
          step: 1
          unit_of_measurement: "°C"
          mode: slider

    curve_base_temp:
      name: "Curve Base Temperature"
      description: "Flow temperature at the heating-off threshold — the bottom anchor of the heat curve. This shapes the curve; use 'Minimum Flow Temperature' for a safety floor."
      default: 25
      selector:
        number:
          min: 15
          max: 40
          step: 1
          unit_of_measurement: "°C"
          mode: slider

    min_flow_temp:
      name: "Minimum Flow Temperature"
      description: "Hard lower limit (safety floor) for the output flow temperature (°C). Does not affect the shape of the heat curve."
      default: 25
      selector:
        number:
          min: 15
          max: 40
          step: 1
          unit_of_measurement: "°C"
          mode: slider

    heating_off_outdoor_temp:
      name: "Outdoor Temp - Heating Off"
      description: "Above this outdoor temperature, heating turns off (°C). Must be higher than 'Heating On' to create a hysteresis dead zone."
      default: 18
      selector:
        number:
          min: 10
          max: 25
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    heating_on_outdoor_temp:
      name: "Outdoor Temp - Heating On"
      description: "Below this outdoor temperature, heating turns back on (°C). Must be lower than 'Heating Off' to prevent rapid toggling."
      default: 13
      selector:
        number:
          min: 5
          max: 20
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    # ── Solar gain correction ─────────────────────────────────────────────
    lux_threshold_low:
      name: "Lux Threshold - Start Reduction"
      description: "Illuminance (lux) at which solar offset begins"
      default: 10000
      selector:
        number:
          min: 0
          max: 50000
          step: 1000
          unit_of_measurement: "lx"
          mode: slider

    lux_threshold_high:
      name: "Lux Threshold - Max Reduction"
      description: "Illuminance (lux) at which solar offset reaches maximum"
      default: 40000
      selector:
        number:
          min: 0
          max: 100000
          step: 1000
          unit_of_measurement: "lx"
          mode: slider

    lux_max_offset:
      name: "Max Solar Offset"
      description: "Maximum flow temperature reduction due to sun (°C)"
      default: 5
      selector:
        number:
          min: 0
          max: 15
          step: 0.5
          unit_of_measurement: "°C"
          mode: slider

    lux_multiplier:
      name: "Lux Sensor Multiplier"
      description: "Scale factor for the lux reading. Use >1 if the sensor is partially shaded (e.g. 2.0 = sensor reads half of real sun). Use <1 if sensor is over-exposed."
      default: 1.0
      selector:
        number:
          min: 0.1
          max: 5.0
          step: 0.1
          unit_of_measurement: "×"
          mode: slider

    # ── Heating demand scaling ─────────────────────────────────────────────
    heating_demand_sensor:
      name: "Total Heating Demand Sensor (optional)"
      description: "Sensor reporting total heating demand (0-100). Scales the heat portion of the flow temperature proportionally. Leave empty to disable."
      default: ""
      selector:
        entity:
          domain: sensor

    heating_demand_neutral:
      name: "Demand Neutral Point"
      description: "Demand value that produces zero offset (no adjustment to the heat curve). Below this, flow temp is reduced; above it, flow temp is increased."
      default: 3
      selector:
        number:
          min: 0
          max: 100
          step: 0.5
          mode: slider

    heating_demand_rate:
      name: "Demand Rate (°C per 10% demand)"
      description: "How many °C of flow temperature to add or subtract per 10 points of demand deviation from the neutral point. E.g. 0.1 = ±1°C per 10% demand."
      default: 0.1
      selector:
        number:
          min: 0.05
          max: 1.0
          step: 0.05
          unit_of_measurement: "°C/%"
          mode: slider

    # ── Output clamp ─────────────────────────────────────────────────────
    max_flow_temp:
      name: "Maximum Flow Temperature"
      description: "Hard upper limit for the calculated flow temperature (°C)"
      default: 67
      selector:
        number:
          min: 45
          max: 75
          step: 1
          unit_of_measurement: "°C"
          mode: slider

    # ── API rate limiting ────────────────────────────────────────────────
    min_change_threshold:
      name: "Minimum Change Threshold"
      description: "Only send a new temperature to the boiler if the target differs from the current setpoint by at least this many degrees. Reduces unnecessary API calls."
      default: 2
      selector:
        number:
          min: 1
          max: 10
          step: 1
          unit_of_measurement: "°C"
          mode: slider

# ═══════════════════════════════════════════════════════════════════════════
# Automation definition
# ═══════════════════════════════════════════════════════════════════════════
mode: restart

trigger:
  # Periodic re-evaluation
  - platform: time_pattern
    minutes: "/30"

  # React to outdoor temperature changes
  - platform: state
    entity_id: !input outdoor_temp_sensor
    id: outdoor_temp_change

  # React to illuminance swings
  - platform: state
    entity_id: !input outdoor_lux_sensor
    id: lux_change

condition: []

action:
  # ── Resolve entity IDs from blueprint inputs ───────────────────────────
  - variables:
      outdoor_temp_entity: !input outdoor_temp_sensor
      outdoor_lux_entity: !input outdoor_lux_sensor
      heating_demand_entity: !input heating_demand_sensor

  # ── Check sensor availability before proceeding ────────────────────────
  - condition: template
    value_template: >-
      {{ states(outdoor_temp_entity) not in ['unavailable', 'unknown']
         and states(outdoor_lux_entity) not in ['unavailable', 'unknown'] }}

  # ── Gather all inputs into variables ────────────────────────────────────
  - variables:
      # Sensor readings
      t_out: "{{ states(outdoor_temp_entity) | float(10) }}"
      lux_raw: "{{ states(outdoor_lux_entity) | float(0) }}"
      lux_mult: !input lux_multiplier
      lux: "{{ (lux_raw | float * lux_mult | float) | round(0) }}"

      # Heat curve parameters
      t_design: !input design_outdoor_temp
      flow_design: !input design_flow_temp
      curve_base: !input curve_base_temp
      flow_min: !input min_flow_temp
      t_off: !input heating_off_outdoor_temp
      t_on: !input heating_on_outdoor_temp

      # Solar parameters
      lux_low: !input lux_threshold_low
      lux_high: !input lux_threshold_high
      max_solar_offset: !input lux_max_offset

      # Heating demand parameters
      demand_neutral: !input heating_demand_neutral
      demand_rate: !input heating_demand_rate

      # Heating demand — linear offset from neutral
      demand_raw: >-
        {% if heating_demand_entity | default('', true) | length > 0
           and states(heating_demand_entity) not in ['unavailable', 'unknown', ''] %}
          {{ states(heating_demand_entity) | float(0) }}
        {% else %}
          {{ demand_neutral }}
        {% endif %}
      demand_offset: "{{ ((demand_raw | float - demand_neutral | float) * demand_rate | float) | round(1) }}"

      # Output clamp
      flow_max: !input max_flow_temp

      # Radiator nonlinearity exponent (convection ΔT^1.3 → inverse ≈ 0.78)
      b: 0.78

  # ── Compute flow temperature ────────────────────────────────────────────
  - variables:
      # Base flow temp from heat curve
      base_flow: >-
        {% if t_out | float >= t_off | float %}
          {{ curve_base }}
        {% elif t_out | float <= t_design | float %}
          {{ flow_design }}
        {% else %}
          {% set demand = (t_off | float - t_out | float) / (t_off | float - t_design | float) %}
          {{ (curve_base | float + (flow_design | float - curve_base | float) * (demand ** b)) | round(1) }}
        {% endif %}

      # Solar gain offset
      solar_offset: >-
        {% if lux | float <= lux_low | float %}
          0
        {% elif lux | float >= lux_high | float %}
          {{ max_solar_offset }}
        {% else %}
          {{ ((lux | float - lux_low | float) / (lux_high | float - lux_low | float) * max_solar_offset | float) | round(1) }}
        {% endif %}

  - variables:
      # Linear demand offset applied to base flow
      demand_adjusted_flow: >-
        {{ (base_flow | float + demand_offset | float) | round(1) }}
      # Raw target before clamping (used to detect "no real demand")
      target_flow_raw: >-
        {{ (demand_adjusted_flow | float - solar_offset | float) | round(1) }}
      # Final clamped target (integer for boiler)
      target_flow: >-
        {{ [flow_min | float, [target_flow_raw | float, flow_max | float] | min] | max | round(0) | int }}

  # ── Rate limiting: read current boiler setpoint ─────────────────────
  - variables:
      boiler_entity: !input boiler_climate
      min_change: !input min_change_threshold
      current_setpoint: "{{ state_attr(boiler_entity, 'temperature') | float(0) }}"
      current_mode: "{{ states(boiler_entity) }}"
      change_big_enough: "{{ (target_flow | int - current_setpoint | int) | abs >= min_change | int }}"
      # Should we turn off? (outdoor warm enough OR calculated flow ≤ minimum)
      should_heat_off: "{{ t_out | float >= t_off | float or target_flow_raw | float <= flow_min | float }}"
      # Should we turn on? (outdoor cold enough AND calculated flow is above minimum —
      # prevents toggle when it's cold but solar gain makes heating pointless)
      should_heat_on: "{{ t_out | float < t_on | float and target_flow_raw | float > flow_min | float }}"
      # Dead zone: between t_on and t_off → maintain current state
      in_dead_zone: "{{ not should_heat_off and not should_heat_on }}"
      # Calculated flow too low → treat like outdoor-warm-enough
      flow_below_min: "{{ target_flow_raw | float <= flow_min | float }}"
      # Mode change (off → heat or heat → off) always goes through
      mode_change: >-
        {% if should_heat_off and current_mode != 'off' %}true
        {% elif should_heat_on and current_mode == 'off' %}true
        {% else %}false{% endif %}
      # In dead zone while off → suppress updates entirely (stay off)
      dead_zone_hold: "{{ in_dead_zone and current_mode == 'off' }}"
      should_update: "{{ not dead_zone_hold and (mode_change == 'true' or change_big_enough) }}"

  # ── Skip if no meaningful change ─────────────────────────────────────
  - condition: template
    value_template: "{{ should_update }}"

  # ── Apply to boiler ────────────────────────────────────────────────────
  - choose:
      # Outdoor temp warm enough → turn heating off
      - conditions:
          - condition: template
            value_template: "{{ t_out | float >= t_off | float }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input boiler_climate
            data:
              hvac_mode: "off"
          - service: system_log.write
            data:
              message: >-
                Weather Comp: Outdoor {{ t_out }}°C ≥ off-threshold {{ t_off }}°C → heating OFF (on-threshold {{ t_on }}°C)
              level: info

      # Calculated flow temp at or below minimum → no real demand, turn off
      - conditions:
          - condition: template
            value_template: "{{ flow_below_min }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: !input boiler_climate
            data:
              hvac_mode: "off"
          - service: system_log.write
            data:
              message: >-
                Weather Comp: Calculated flow {{ target_flow_raw }}°C ≤ min {{ flow_min }}°C → no demand, heating OFF
              level: info

      # Dead zone: between t_on and t_off while currently off → stay off
      - conditions:
          - condition: template
            value_template: "{{ in_dead_zone and current_mode == 'off' }}"
        sequence:
          - service: system_log.write
            data:
              message: >-
                Weather Comp: Outdoor {{ t_out }}°C in dead zone ({{ t_on }}–{{ t_off }}°C), currently off → staying OFF
              level: info

    # Otherwise → set calculated flow temperature
    default:
      - service: climate.set_temperature
        target:
          entity_id: !input boiler_climate
        data:
          temperature: "{{ target_flow }}"
          hvac_mode: heat
      - service: system_log.write
        data:
          message: >-
            Weather Comp: Outdoor={{ t_out }}°C (on<{{ t_on }}°C, off≥{{ t_off }}°C),
            Lux={{ lux }}(raw={{ lux_raw }},x{{ lux_mult }}),
            Base={{ base_flow }}°C, DemandAdj={{ demand_adjusted_flow }}°C(demand={{ demand_raw }},neutral={{ demand_neutral }},offset={{ demand_offset }}°C,rate={{ demand_rate }}),
            SolarOffset={{ solar_offset }}°C,
            MaxClamp={{ flow_max }}°C, Prev={{ current_setpoint }}°C, Δ={{ (target_flow | int - current_setpoint | int) | abs }}°C
            → Flow target={{ target_flow }}°C
          level: info
